<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Материалы рулонной этикетки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --accent-color: #facc15; /* yellow-400 */
            --accent-text: #111827;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --approved-bg: rgba(74, 222, 128, 0.1);
            --unapproved-bg: rgba(248, 113, 113, 0.1);
        }

        html.dark {
            --bg-primary: #3f3f46;      /* zinc-700 */
            --bg-secondary: #27272a;    /* zinc-800 */
            --text-primary: #f4f4f5;    /* zinc-100 */
            --text-secondary: #a1a1aa;  /* zinc-400 */
            --accent-color: #facc15;    /* yellow-400 */
            --accent-text: #18181b;     /* zinc-900 */
            --border-color: #52525b;    /* zinc-600 */
            --card-bg: #3f3f46;         /* zinc-700 */
            --shadow-color: rgba(0, 0, 0, 0.4);
            --approved-bg: rgba(74, 222, 128, 0.15);
            --unapproved-bg: rgba(248, 113, 113, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .main-container { background-color: var(--bg-secondary); }
        .header-title { color: var(--text-primary); }
        .card { background-color: var(--card-bg); box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color); }
        .form-label { color: var(--text-secondary); }
        .form-input, .form-select { 
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .form-input:focus, .form-select:focus {
            --tw-ring-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        .btn-primary:hover {
            filter: brightness(0.9);
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .filter-btn.active-filter {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-color: var(--accent-color);
        }
        .filter-btn:not(.active-filter) {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
         .filter-btn:not(.active-filter):hover {
            background-color: var(--bg-secondary);
        }
        .sort-btn {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: background-color 0.2s;
        }
        .sort-btn:hover {
            background-color: var(--bg-secondary);
        }
        .category-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        .category-header {
            color: var(--text-primary);
        }
        .category-header-approved {
            background-color: var(--approved-bg);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .category-header-unapproved {
            background-color: var(--unapproved-bg);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .history-item-add { background-color: rgba(22, 163, 74, 0.1); }
        .history-item-subtract { background-color: rgba(239, 68, 68, 0.1); }

    </style>
</head>
<body class="main-container">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="mb-8 relative">
            <div class="text-center">
                <h1 class="text-3xl sm:text-4xl font-bold header-title">Материалы рулонной этикетки</h1>
            </div>
            <!-- Theme Toggle -->
            <div class="absolute top-0 right-0">
                <label for="theme-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="theme-toggle" class="sr-only peer">
                        <div class="w-14 h-8 rounded-full bg-gray-300 dark:bg-zinc-600 peer-checked:bg-yellow-400 transition-colors"></div>
                        <div class="absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform peer-checked:translate-x-6"></div>
                    </div>
                </label>
            </div>
        </header>

        <!-- Форма для добавления нового материала -->
        <div class="card p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 header-title">Добавить материал</h2>
            <form id="add-material-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="material-category" class="block text-sm font-medium form-label mb-1">Категория</label>
                    <select id="material-category" required class="form-select w-full px-4 py-2 border rounded-lg transition">
                        <option value="Жидкие расходники">Жидкие расходники</option>
                        <option value="Краска">Краска</option>
                        <option value="Утвержденная самоклейка">Утвержденная самоклейка</option>
                        <option value="Самоклейка тест">Самоклейка тест</option>
                        <option value="Не утвержденная самоклейка">Не утвержденная самоклейка</option>
                        <option value="Фольга ДжетТач">Фольга ДжетТач</option>
                        <option value="Фольга DMS">Фольга DMS</option>
                        <option value="Другое">Другое</option>
                    </select>
                </div>
                <div>
                    <label for="material-name" class="block text-sm font-medium form-label mb-1">Название</label>
                    <input type="text" id="material-name" list="material-names-list" placeholder="Выберите или введите" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                    <datalist id="material-names-list"></datalist>
                </div>
                <div>
                    <label for="material-nomenclature" class="block text-sm font-medium form-label mb-1">Номенклатура поставщика</label>
                    <input type="text" id="material-nomenclature" placeholder="Введите номенклатуру" class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div id="material-width-container" class="hidden">
                    <label for="material-width" class="block text-sm font-medium form-label mb-1">Ширина (мм)</label>
                    <input type="number" id="material-width" placeholder="330" class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div>
                    <label for="material-quantity" class="block text-sm font-medium form-label mb-1">Количество</label>
                    <input type="number" id="material-quantity" placeholder="1000" step="any" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div>
                    <label for="material-unit" class="block text-sm font-medium form-label mb-1">Ед. изм.</label>
                    <select id="material-unit" required class="form-select w-full px-4 py-2 border rounded-lg transition">
                        <option value="кг">кг</option>
                        <option value="л">л</option>
                        <option value="м/п">м/п</option>
                        <option value="шт.">шт.</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary md:col-span-3 w-full font-semibold py-2.5 px-4 rounded-lg transition duration-300 mt-2">
                    Добавить
                </button>
            </form>
        </div>

        <!-- Список материалов -->
        <div>
            <h2 class="text-2xl font-semibold mb-4 header-title">Складские остатки</h2>
            
            <div class="mb-4">
                <label for="name-search-input" class="block text-sm font-medium form-label mb-1">Поиск по названию или номенклатуре</label>
                <input type="text" id="name-search-input" placeholder="Введите название или номенклатуру..." class="form-input w-full px-4 py-2 border rounded-lg transition">
            </div>

            <div id="category-filters" class="flex flex-wrap gap-2 mb-6">
                <button data-category="All" class="filter-btn active-filter">Все</button>
                <button data-category="Жидкие расходники" class="filter-btn">Жидкие расходники</button>
                <button data-category="Краска" class="filter-btn">Краска</button>
                <button data-category="Утвержденная самоклейка" class="filter-btn" style="background-color: var(--approved-bg);">Утвержденная самоклейка</button>
                <button data-category="Самоклейка тест" class="filter-btn">Самоклейка тест</button>
                <button data-category="Не утвержденная самоклейка" class="filter-btn" style="background-color: var(--unapproved-bg);">Не утвержденная самоклейка</button>
                <button data-category="Фольга ДжетТач" class="filter-btn">Фольга ДжетТач</button>
                <button data-category="Фольга DMS" class="filter-btn">Фольга DMS</button>
                <button data-category="Другое" class="filter-btn">Другое</button>
            </div>
            
            <div id="width-search-container" class="mb-6 hidden">
                <label for="width-search-input" class="block text-sm font-medium form-label mb-1">Поиск по ширине (мм)</label>
                <div class="flex gap-2">
                    <input type="number" id="width-search-input" placeholder="Например, 330" class="form-input w-full md:w-1/3 px-4 py-2 border rounded-lg transition">
                    <button id="width-search-reset" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-zinc-600 dark:text-zinc-200 dark:hover:bg-zinc-500 rounded-lg hover:bg-gray-300 transition">Сброс</button>
                </div>
            </div>
            
            <div id="error-container" class="hidden my-4 p-4 border border-red-500 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg">
                <p id="error-message" class="text-center"></p>
            </div>
            <p id="loading-message" class="text-center text-secondary py-4">Загрузка данных...</p>
            <div id="materials-list" class="space-y-6">
                <!-- Категории и материалы будут отображаться здесь -->
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="update-modal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-sm m-4 relative"><h3 class="text-xl font-semibold mb-4 header-title" id="modal-title">Обновить количество</h3><form id="update-quantity-form"><input type="hidden" id="modal-material-id"><input type="hidden" id="modal-action-type"><div><label for="quantity-change" class="block text-sm font-medium form-label mb-1">Значение</label><input type="number" id="quantity-change" min="0" step="any" placeholder="Введите число" required class="form-input w-full px-4 py-2 border rounded-lg transition"></div><div class="mt-4"><label for="quantity-comment" class="block text-sm font-medium form-label mb-1">Комментарий (необязательно)</label><textarea id="quantity-comment" placeholder="Например, номер заказа или причина" rows="3" class="form-input w-full px-4 py-2 border rounded-lg transition"></textarea></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-update" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Отмена</button><button type="button" id="write-off-all-btn" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition hidden">Списать все</button><button type="submit" class="btn-primary px-4 py-2 rounded-lg transition">Подтвердить</button></div></form></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-sm m-4 relative"><h3 class="text-xl font-semibold mb-2 header-title">Подтверждение</h3><p class="text-secondary mb-6">Вы уверены, что хотите удалить этот материал?</p><div class="flex justify-end space-x-3"><button type="button" id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Отмена</button><button type="button" id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Удалить</button></div></div></div>
    
    <div id="history-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card p-6 rounded-2xl w-full max-w-lg m-4 relative flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-border-color">
                <h3 class="text-xl font-semibold header-title" id="history-modal-title">История операций</h3>
                <button id="close-history-modal" class="text-secondary hover:text-primary">&times;</button>
            </div>
            <div id="history-log-container" class="overflow-y-auto space-y-2"></div>
        </div>
    </div>


    <script type="module">
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyAaIh33CJZXGzN9JmzgCLOER8AfJJKIV80",
          authDomain: "cveta-67f31.firebaseapp.com",
          projectId: "cveta-67f31",
          storageBucket: "cveta-67f31.appspot.com",
          messagingSenderId: "379571445431",
          appId: "1:379571445431:web:d41e2477feac5c29e97732",
          measurementId: "G-7EYBRBV2JN"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs, runTransaction, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId;
        let materialsCollectionRef;
        let unsubscribe;
        let allMaterials = [];
        let currentFilter = 'All';
        let sortConfig = { category: 'Утвержденная самоклейка', direction: 'asc' };

        const nomenclatureMap = {
            'Бумажная полуглянцевая': 'semi gloss paper am/aw01/yellow glassine(fz)',
            'Белая полимерная': '60# pp pearl film(tc)/acrylic w05/white glassine',
            'Прозрачный хрусталь': '50# transparent pp film(tc)/acrylic 32/30# pet liner',
            'Императорский синий': 'BeautyStick(1-15)Blue',
            'Императорский красный': 'BeautyStick(01-15)Silver',
            'Императорское золото': 'BeautyStick(1-15)Gold',
            'Императорское серебро': 'BeautyStick(1-15)Red',
            'Глянцевое серебро': 'Bright Silver PP 50um/AS500/white glassine',
            'Голографическое серебро': '50PP TRANSPARENT AS500WG60 125г/м2+MPET12 мкм WP-02 Радуга',
            'Прозрачный сахар': 'Glitter Transparent LamiFilm(05-90)GT-LT85-30P',
        };

        const materialNameSuggestions = {
            'Утвержденная самоклейка': ['Бумажная полуглянцевая', 'Белая полимерная', 'Прозрачный хрусталь', 'Императорский синий', 'Императорский красный', 'Императорское золото', 'Императорское серебро', 'Глянцевое серебро', 'Голографическое серебро', 'Прозрачный сахар'],
            'Самоклейка тест': ['Бумажная - белая термобумага', 'Бумажная - полуглянцевая', 'Бумажная - белая винная', 'Бумажная - белая матовая', 'Бумажная - белая термобумага морозостойкая', 'Бумажная - белая полуглянцевая бумага', 'Бумажная - серебряная глянцевая бумага', 'Бумажная - серебряная матовая бумага', 'Бумажная - китайская полуглянцевая бумага', 'Полимерная - белая', 'Полимерная - мутная прозрачка', 'Полимерная - супер прозрачная', 'Полимерная - прозрачная', 'Полимерная - серебряная глянцевая', 'Полимерная - белая мутная', 'Полимерная - тонкая прозрачная', 'Другие - прозрачный ПВХ'],
            'Не утвержденная самоклейка': ['Голографическая радуга', 'Черная самоклейка с тач покрытием', 'Мутная прозрачка (Pe85)', 'Винная бумага (Antarctic white от Стиктрейд)'],
            'Фольга ДжетТач': [],
            'Фольга DMS': ['Фольга золото ППФ', 'Фольга серебро ППФ', 'Фольга голография ППФ', 'Фольга зеленая ППФ', 'Фольга голография ДубльВ', 'Фольга золото ДубльВ', 'Фольга серебро ДубльВ'],
            'Краска': ['GIP White', 'GIP Cyan', 'GIP Magenta', 'GIP Yellow', 'GIP Key'],
            'Жидкие расходники': ['Антифриз Felix G12', 'Вода дистиллированная Oilright', 'Антифриз Prestone (для GIP)', 'Wash (для GIP)', 'Лак DMS SJ-SM01', 'Этилацетат (для мойки)', 'Метоксипропанол (УФ смывка)', 'Изопропиловый спирт (для мойки)', 'Platenclene (Очиститель валов)', 'Матовый лак VMG UV Flexo', 'Матовый лак Танзор Графилак UV 903', 'Праймер Танзор Графилак UV 368', 'Праймер Артмарк BUF-6301D-4', 'Wash DMS SJ-QX01', 'Водный раствор аммиака ЧДА']
        };

        const initialDataRaw = [
            { name: "Антифриз Felix G12", quantity: 20, unit: "кг", category: "Жидкие расходники" },{ name: "Вода дистиллированная Oilright", quantity: 10, unit: "л", category: "Жидкие расходники" },{ name: "Антифриз Prestone (для GIP)", quantity: 7.56, unit: "л", category: "Жидкие расходники" },{ name: "Wash (для GIP)", quantity: 52, unit: "л", category: "Жидкие расходники" },
            { name: "GIP White", quantity: 96.8, unit: "л", category: "Краска" }, { name: "GIP Cyan", quantity: 63.5, unit: "л", category: "Краска" }, { name: "GIP Magenta", quantity: 62.5, unit: "л", category: "Краска" }, { name: "GIP Yellow", quantity: 64.3, unit: "л", category: "Краска" }, { name: "GIP Key", quantity: 63.2, unit: "л", category: "Краска" },
            { name: "Лак DMS SJ-SM01", quantity: 70.5, unit: "л", category: "Жидкие расходники" },{ name: "Этилацетат (для мойки)", quantity: 35, unit: "л", category: "Жидкие расходники" },{ name: "Метоксипропанол (УФ смывка)", quantity: 16, unit: "кг", category: "Жидкие расходники" },{ name: "Изопропиловый спирт (для мойки)", quantity: 20, unit: "л", category: "Жидкие расходники" },{ name: "Platenclene (Очиститель валов)", quantity: 0.7, unit: "л", category: "Жидкие расходники" },{ name: "Матовый лак VMG UV Flexo", quantity: 37, unit: "кг", category: "Жидкие расходники" },{ name: "Матовый лак Танзор Графилак UV 903", quantity: 9, unit: "кг", category: "Жидкие расходники" },{ name: "Праймер Танзор Графилак UV 368", quantity: 4.5, unit: "кг", category: "Жидкие расходники" },{ name: "Праймер Артмарк BUF-6301D-4", quantity: 17.5, unit: "кг", category: "Жидкие расходники" },{ name: "Wash DMS SJ-QX01", quantity: 1, unit: "л", category: "Жидкие расходники" },{ name: "Водный раствор аммиака ЧДА", quantity: 9, unit: "кг", category: "Жидкие расходники" },{ name: "Бумажная полуглянцевая 330 мм", quantity: 43956, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Белая полимерная 330 мм", quantity: 7992, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный хрусталь 330 мм", quantity: 15000, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный хрусталь 280 мм", quantity: 9280, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорский синий 330 мм", quantity: 11050, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорский красный 330 мм", quantity: 11380, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское золото 330 мм", quantity: 7250, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское золото 270 мм", quantity: 4000, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское серебро 330 мм", quantity: 10950, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Глянцевое серебро 210 мм", quantity: 17700, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Глянцевое серебро 330 мм", quantity: 76500, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 330 мм", quantity: 5578, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 214 мм", quantity: 6140, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 150 мм", quantity: 6140, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный сахар 330 мм", quantity: 5450, unit: "м/п", category: "Утвержденная самоклейка" },
            { name: "Фольга золото ППФ 330 мм", quantity: 4900, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ППФ 330 мм", quantity: 4900, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга голография ППФ 330 мм", quantity: 440, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга зеленая ППФ 330 мм", quantity: 450, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга голография ДубльВ 330 мм", quantity: 1500, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 330 мм", quantity: 500, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 330 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 100 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 130 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 150 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 160 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 210 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 130 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 150 мм", quantity: 5000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 160 мм", quantity: 11000, unit: "м/п", category: "Фольга DMS" },
            // Самоклейка тест
            { name: "Бумажная - белая термобумага 210 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 250 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 290 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 280 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая винная 300 мм", quantity: 30, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 225 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 255 мм", quantity: 370, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая матовая 210 мм", quantity: 138, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 251 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага морозостойкая 270 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая матовая 250 мм", quantity: 48, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая полуглянцевая бумага 320 мм", quantity: 490, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая полуглянцевая бумага 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая винная 140 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - серебряная глянцевая бумага 320 мм", quantity: 400, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - серебряная матовая бумага 320 мм", quantity: 390, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - китайская полуглянцевая бумага 330 мм", quantity: 500, unit: "м/п", category: "Самоклейка тест" },
            { name: "Полимерная - белая 305 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 320 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - супер прозрачная 290 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - супер прозрачная 250 мм", quantity: 60, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 330 мм", quantity: 230, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 170 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 330 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 300 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 280 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 230 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 265 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - серебряная глянцевая 330 мм", quantity: 40, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 330 мм", quantity: 350, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 295 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 250 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачная 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 330 мм", quantity: 400, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая мутная 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - тонкая прозрачная 330 мм", quantity: 800, unit: "м/п", category: "Самоклейка тест" },
            { name: "Другие - прозрачный ПВХ 240 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" },
            // Не утвержденная самоклейка
            { name: "Голографическая радуга 330 мм", quantity: 11910, unit: "м/п", category: "Не утвержденная самоклейка", nomenclature: "50PP TRANSPARENT AS500WG60 125г/м2+UV TOP(01-18) IRIS T розово-зеленая" },
            { name: "Черная самоклейка с тач покрытием 330 мм", quantity: 272, unit: "м/п", category: "Не утвержденная самоклейка" },
            { name: "Мутная прозрачка (Pe85) 330 мм", quantity: 11589, unit: "м/п", category: "Не утвержденная самоклейка", nomenclature: "transparent pe film 85#/w05/white glassine" },
            { name: "Винная бумага (Antarctic white от Стиктрейд) 330 мм", quantity: 100, unit: "м/п", category: "Не утвержденная самоклейка" },
        ];

        function processInitialData(data) {
            return data.map(item => {
                const match = item.name.match(/(\s*\d+\s*мм)/);
                let newItem = { ...item, width: null, nomenclature: item.nomenclature || null };
                if (match) {
                    newItem.width = parseInt(match[1].trim(), 10);
                    newItem.name = item.name.replace(match[0], '').trim();
                }
                if (newItem.category === 'Утвержденная самоклейка' && nomenclatureMap[newItem.name]) {
                    newItem.nomenclature = nomenclatureMap[newItem.name];
                }
                return newItem;
            });
        }

        const initialData = processInitialData(initialDataRaw);

        function handleFirebaseError(error, context) {
            console.error(`Firebase Error in ${context}:`, error);
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const loadingMessage = document.getElementById('loading-message');
            
            loadingMessage.style.display = 'none';

            if (error.code === 'auth/configuration-not-found') {
                errorMessage.innerHTML = '<strong>Ошибка конфигурации:</strong> Анонимный вход не включен в вашем проекте Firebase. <br>Пожалуйста, перейдите в Firebase Console -> Authentication -> Sign-in method и включите провайдера "Anonymous".';
            } else if (error.message && error.message.includes('Cloud Firestore API has not been used')) {
                errorMessage.innerHTML = `<strong>Ошибка конфигурации:</strong> Cloud Firestore API не включен в вашем проекте. <br>Пожалуйста, перейдите по <a href="https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=${firebaseConfig.projectId}" target="_blank" class="font-bold underline">этой ссылке</a>, нажмите "Включить" (Enable), подождите 2-3 минуты и перезагрузите эту страницу.`;
            } else if (error.message && error.message.includes('The database (default) does not exist')) {
                 errorMessage.innerHTML = `<strong>Ошибка конфигурации:</strong> База данных Cloud Firestore не создана в вашем проекте.
                    <br><br><strong>Что делать:</strong>
                    <ol class="list-decimal list-inside text-left">
                        <li>Перейдите в <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore" target="_blank" class="font-bold underline">раздел Firestore вашего проекта</a>.</li>
                        <li>Нажмите на большую кнопку <strong>"Создать базу данных"</strong>.</li>
                        <li>Выберите <strong>"Запустить в тестовом режиме"</strong> (Start in test mode).</li>
                        <li>Выберите регион сервера (любой подойдет) и нажмите "Включить".</li>
                        <li>После создания базы данных, вернитесь сюда и перезагрузите страницу.</li>
                    </ol>`;
            } else if (error.code === 'permission-denied' || error.message.includes('permission-denied') || error.message.includes('insufficient permissions')) {
                errorMessage.innerHTML = `<strong>Ошибка доступа:</strong> У вас нет прав для выполнения этого действия.
                    <br><br><strong>Что делать:</strong>
                    <ol class="list-decimal list-inside text-left">
                        <li>Перейдите в <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" class="font-bold underline">раздел "Правила" Firestore вашего проекта</a>.</li>
                        <li>Замените существующие правила на следующие, чтобы разрешить доступ авторизованным пользователям:</li>
                    </ol>
                    <pre class="bg-gray-100 dark:bg-zinc-800 p-2 rounded mt-2 text-left text-xs"><code>service cloud.firestore {
    match /databases/{database}/documents {
        match /{document=**} {
            allow read, write: if request.auth != null;
        }
    }
}</code></pre>
                    <p class="mt-2">Нажмите "Опубликовать" и перезагрузите эту страницу.</p>`;
            } else {
                 errorMessage.textContent = `Произошла неизвестная ошибка при "${context}". Проверьте консоль для деталей.`;
            }
            errorContainer.classList.remove('hidden');
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        materialsCollectionRef = collection(db, `materials`);
                        checkAndAddInitialData();
                        listenForMaterials();
                    } else {
                        userId = null;
                        if (unsubscribe) unsubscribe();
                    }
                });

                await signInAnonymously(auth);
                
                setupEventListeners();
                handleCategoryChange();
            } catch (error) {
                handleFirebaseError(error, 'инициализации');
            }
        });
        
        async function checkAndAddInitialData() {
             try {
                const snapshot = await getDocs(materialsCollectionRef);
                if (snapshot.empty) {
                    const batch = writeBatch(db);
                    initialData.forEach(material => {
                        const docRef = doc(materialsCollectionRef);
                        batch.set(docRef, { ...material, createdAt: new Date() });
                    });
                    await batch.commit();
                }
            } catch (error) {
                handleFirebaseError(error, 'проверке и добавлении начальных данных');
            }
        }

        function listenForMaterials() {
            if (unsubscribe) unsubscribe();
            const q = query(materialsCollectionRef);
            unsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('error-container').classList.add('hidden');
                allMaterials = [];
                snapshot.forEach((doc) => {
                    allMaterials.push({ id: doc.id, ...doc.data() });
                });
                renderMaterials();
            }, (error) => {
                handleFirebaseError(error, 'получении данных в реальном времени');
            });
        }

        async function addMaterial(name, quantity, unit, category, width, nomenclature) {
            try {
                const materialWidth = width ? Number(width) : null;
                const q = query(
                    materialsCollectionRef,
                    where("name", "==", name),
                    where("category", "==", category),
                    where("width", "==", materialWidth)
                );
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const existingDoc = querySnapshot.docs[0];
                    await updateMaterialQuantity(existingDoc.id, Number(quantity), 'Приход');
                } else {
                    const newMaterialRef = doc(materialsCollectionRef);
                    const historyRef = collection(newMaterialRef, 'history');
                    const batch = writeBatch(db);
                    const materialData = { name, quantity: Number(quantity), unit, category, createdAt: new Date(), width: materialWidth, nomenclature: nomenclature || null };
                    batch.set(newMaterialRef, materialData);
                    batch.set(doc(historyRef), {
                        change: Number(quantity),
                        newQuantity: Number(quantity),
                        type: 'add',
                        timestamp: new Date(),
                        comment: 'Первоначальное добавление'
                    });
                    await batch.commit();
                }
            } catch (error) {
                 handleFirebaseError(error, 'добавлении материала');
            }
        }
        
        async function updateMaterialQuantity(id, quantityChange, comment = '') {
            const materialRef = doc(materialsCollectionRef, id);
            const historyRef = collection(materialRef, 'history');
            try {
                await runTransaction(db, async (transaction) => {
                    const materialDoc = await transaction.get(materialRef);
                    if (!materialDoc.exists()) { throw "Документ не существует!"; }
                    const currentQuantity = materialDoc.data().quantity;
                    const newQuantity = currentQuantity + quantityChange;
                    if (newQuantity < 0) { return; }
                    
                    transaction.update(materialRef, { quantity: newQuantity });
                    
                    const historyDocRef = doc(historyRef);
                    transaction.set(historyDocRef, {
                        change: quantityChange,
                        newQuantity: newQuantity,
                        type: quantityChange > 0 ? 'add' : 'subtract',
                        timestamp: new Date(),
                        comment: comment
                    });
                });
            } catch (error) {
                handleFirebaseError(error, 'обновлении количества');
            }
        }
        
        async function deleteMaterial(id) {
            try {
                await deleteDoc(doc(materialsCollectionRef, id));
            } catch (error) {
                handleFirebaseError(error, 'удалении материала');
            }
        }

        function renderMaterials() {
            const listElement = document.getElementById('materials-list');
            const loadingMessage = document.getElementById('loading-message');
            const widthSearchInput = document.getElementById('width-search-input');
            const nameSearchInput = document.getElementById('name-search-input');
            
            let materialsToRender = currentFilter === 'All' ? allMaterials : allMaterials.filter(m => m.category === currentFilter);
            const nameSearchTerm = nameSearchInput.value.toLowerCase().trim();
            if (nameSearchTerm) {
                materialsToRender = materialsToRender.filter(m => 
                    m.name.toLowerCase().includes(nameSearchTerm) || 
                    (m.nomenclature && m.nomenclature.toLowerCase().includes(nameSearchTerm))
                );
            }
            const searchWidth = widthSearchInput.value;
            if (searchWidth) {
                 materialsToRender = materialsToRender.filter(m => m.width === Number(searchWidth));
            }

            listElement.innerHTML = '';
            
            if (document.getElementById('error-container').classList.contains('hidden')) {
                loadingMessage.style.display = materialsToRender.length === 0 ? 'block' : 'none';
                loadingMessage.textContent = 'Материалы не найдены.';
            }
            
            const groupedByCategory = materialsToRender.reduce((acc, material) => {
                const category = material.category || 'Другое';
                if (!acc[category]) acc[category] = [];
                acc[category].push(material);
                return acc;
            }, {});

            Object.keys(groupedByCategory).sort().forEach(category => {
                const categoryHeaderContainer = document.createElement('div');
                categoryHeaderContainer.className = 'category-header-container';
                if (category === 'Утвержденная самоклейка') {
                    categoryHeaderContainer.classList.add('category-header-approved');
                } else if (category === 'Не утвержденная самоклейка') {
                    categoryHeaderContainer.classList.add('category-header-unapproved');
                }

                categoryHeaderContainer.innerHTML = `<h3 class="text-xl font-bold category-header">${category}</h3>`;

                if (category === 'Утвержденная самоклейка' || category === 'Самоклейка тест' || category === 'Не утвержденная самоклейка') {
                    const sortButton = document.createElement('button');
                    sortButton.className = 'sort-btn';
                    sortButton.dataset.category = category;
                    sortButton.innerHTML = `Ширина ${sortConfig.direction === 'asc' ? '▲' : '▼'}`;
                    categoryHeaderContainer.appendChild(sortButton);
                }

                const categoryContainer = document.createElement('div');
                categoryContainer.appendChild(categoryHeaderContainer);
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-3';
                
                const sortedItems = groupedByCategory[category].sort((a, b) => {
                    if (category === 'Утвержденная самоклейка' || category === 'Самоклейка тест' || category === 'Не утвержденная самоклейка') {
                        return sortConfig.direction === 'asc' ? (a.width || 0) - (b.width || 0) : (b.width || 0) - (a.width || 0);
                    }
                    return a.name.localeCompare(b.name);
                });

                sortedItems.forEach(material => {
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4';
                    const quantityColor = material.quantity < 100 ? 'text-red-500' : 'text-green-600';

                    card.innerHTML = `
                        <div class="flex-grow">
                             <div class="flex items-baseline gap-3 flex-wrap">
                                <h4 class="text-lg font-bold header-title">${material.name}</h4>
                                ${material.width ? `<p class="text-base font-semibold text-yellow-400 bg-yellow-400/10 px-2 py-0.5 rounded-full">${material.width} мм</p>` : ''}
                            </div>
                            ${material.nomenclature ? `<p class="text-xs text-secondary mt-1">${material.nomenclature}</p>` : ''}
                            <p class="text-sm text-secondary mt-2">Остаток:</p>
                            <p class="text-2xl font-bold ${quantityColor}">${material.quantity} <span class="text-base font-normal">${material.unit}</span></p>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button data-id="${material.id}" data-action="add" class="update-btn flex-1 sm:flex-none w-10 h-10 text-green-700 hover:bg-green-100 dark:hover:bg-green-900/50 dark:text-green-400 rounded-full flex items-center justify-center text-2xl font-bold transition">+</button>
                            <button data-id="${material.id}" data-action="subtract" class="update-btn flex-1 sm:flex-none w-10 h-10 text-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 dark:text-yellow-400 rounded-full flex items-center justify-center text-2xl font-bold transition">-</button>
                            <button data-id="${material.id}" data-name="${material.name}" class="history-btn flex-1 sm:flex-none w-10 h-10 text-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900/50 dark:text-blue-400 rounded-full flex items-center justify-center transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                            <button data-id="${material.id}" class="delete-btn flex-1 sm:flex-none w-10 h-10 text-red-700 hover:bg-red-100 dark:hover:bg-red-900/50 dark:text-red-400 rounded-full flex items-center justify-center transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>`;
                    itemsContainer.appendChild(card);
                });
                categoryContainer.appendChild(itemsContainer);
                listElement.appendChild(categoryContainer);
            });
        }

        function handleCategoryChange() {
            const categorySelect = document.getElementById('material-category');
            const widthContainer = document.getElementById('material-width-container');
            const nameDatalist = document.getElementById('material-names-list');
            const nameInput = document.getElementById('material-name');

            const selectedCategory = categorySelect.value;
            const categoriesWithWidth = ['Утвержденная самоклейка', 'Самоклейка тест', 'Не утвержденная самоклейка', 'Фольга ДжетТач', 'Фольга DMS'];

            widthContainer.classList.toggle('hidden', !categoriesWithWidth.includes(selectedCategory));
            
            nameDatalist.innerHTML = '';
            nameInput.value = '';

            if (materialNameSuggestions[selectedCategory]) {
                materialNameSuggestions[selectedCategory].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    nameDatalist.appendChild(option);
                });
            }
        }

        function setupEventListeners() {
            const addForm = document.getElementById('add-material-form');
            addForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('material-name').value.trim();
                const quantity = document.getElementById('material-quantity').value;
                const unit = document.getElementById('material-unit').value;
                const category = document.getElementById('material-category').value;
                const width = document.getElementById('material-width').value;
                const nomenclature = document.getElementById('material-nomenclature').value.trim();

                if (name && quantity && unit && category) {
                    addMaterial(name, quantity, unit, category, width || null, nomenclature || null);
                    // Reset only necessary fields
                    document.getElementById('material-name').value = '';
                    document.getElementById('material-quantity').value = '';
                    document.getElementById('material-width').value = '';
                    document.getElementById('material-nomenclature').value = '';
                    handleCategoryChange(); // Update datalist for the current category
                }
            });

            document.getElementById('material-category').addEventListener('change', handleCategoryChange);

            document.getElementById('materials-list').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('sort-btn')) {
                    sortConfig.category = target.dataset.category;
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    renderMaterials();
                    return;
                }
                const materialId = target.dataset.id;
                if (target.classList.contains('update-btn')) openUpdateModal(materialId, target.dataset.action);
                if (target.classList.contains('delete-btn')) openDeleteConfirmModal(materialId);
                if (target.classList.contains('history-btn')) openHistoryModal(materialId, target.dataset.name);
            });

            document.getElementById('category-filters').addEventListener('click', (e) => {
                const target = e.target.closest('button.filter-btn');
                if (target) {
                    currentFilter = target.dataset.category;
                    document.querySelector('#category-filters .active-filter').classList.remove('active-filter');
                    target.classList.add('active-filter');
                    const showWidthSearch = currentFilter === 'Утвержденная самоклейка' || currentFilter === 'Самоклейка тест' || currentFilter === 'Не утвержденная самоклейка' || currentFilter === 'Фольга ДжетТач' || currentFilter === 'Фольга DMS' || currentFilter === 'All';
                    document.getElementById('width-search-container').classList.toggle('hidden', !showWidthSearch);
                    document.getElementById('width-search-input').value = '';
                    renderMaterials();
                }
            });
            
            document.getElementById('name-search-input').addEventListener('input', renderMaterials);
            document.getElementById('width-search-input').addEventListener('input', renderMaterials);
            document.getElementById('width-search-reset').addEventListener('click', () => {
                document.getElementById('width-search-input').value = '';
                renderMaterials();
            });

            // Modal Listeners
            document.getElementById('update-quantity-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('modal-material-id').value;
                const action = document.getElementById('modal-action-type').value;
                const changeValue = Number(document.getElementById('quantity-change').value);
                const comment = document.getElementById('quantity-comment').value.trim();
                if (id && changeValue > 0) {
                    updateMaterialQuantity(id, action === 'add' ? changeValue : -changeValue, comment);
                    closeUpdateModal();
                }
            });

            document.getElementById('write-off-all-btn').addEventListener('click', () => {
                const id = document.getElementById('modal-material-id').value;
                const material = allMaterials.find(m => m.id === id);
                const comment = document.getElementById('quantity-comment').value.trim() || 'Списание всех остатков';
                if (material) {
                    updateMaterialQuantity(id, -material.quantity, comment);
                    closeUpdateModal();
                }
            });

            document.getElementById('cancel-update').addEventListener('click', closeUpdateModal);
            document.querySelector('#update-modal .modal-backdrop').addEventListener('click', closeUpdateModal);
            document.getElementById('confirm-delete').addEventListener('click', () => {
                const materialId = document.getElementById('confirm-delete').dataset.id;
                if(materialId) {
                    deleteMaterial(materialId);
                    closeDeleteConfirmModal();
                }
            });
            document.getElementById('cancel-delete').addEventListener('click', closeDeleteConfirmModal);
            document.querySelector('#delete-confirm-modal .modal-backdrop').addEventListener('click', closeDeleteConfirmModal);
            document.getElementById('close-history-modal').addEventListener('click', closeHistoryModal);
            document.querySelector('#history-modal .modal-backdrop').addEventListener('click', closeHistoryModal);
        
            // Theme toggle listener
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
            
            // Apply saved theme on load
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                themeToggle.checked = true;
                document.documentElement.classList.add('dark');
            } else {
                themeToggle.checked = false;
                document.documentElement.classList.remove('dark');
            }
        }

        function openUpdateModal(id, action) {
            const modal = document.getElementById('update-modal');
            const writeOffBtn = document.getElementById('write-off-all-btn');
            document.getElementById('modal-material-id').value = id;
            document.getElementById('modal-action-type').value = action;
            document.getElementById('update-quantity-form').reset();
            document.getElementById('modal-title').textContent = action === 'add' ? 'Приход материала' : 'Списание материала';
            
            if (action === 'subtract') {
                writeOffBtn.classList.remove('hidden');
            } else {
                writeOffBtn.classList.add('hidden');
            }

            modal.style.display = 'flex';
        }
        function closeUpdateModal() { document.getElementById('update-modal').style.display = 'none'; }
        function openDeleteConfirmModal(id) {
            const modal = document.getElementById('delete-confirm-modal');
            document.getElementById('confirm-delete').dataset.id = id;
            modal.style.display = 'flex';
        }
        function closeDeleteConfirmModal() { document.getElementById('delete-confirm-modal').style.display = 'none'; }

        async function openHistoryModal(id, name) {
            const modal = document.getElementById('history-modal');
            const title = document.getElementById('history-modal-title');
            const container = document.getElementById('history-log-container');
            
            title.textContent = `История: ${name}`;
            container.innerHTML = '<p class="text-secondary">Загрузка истории...</p>';
            modal.style.display = 'flex';

            try {
                const historyRef = collection(materialsCollectionRef, id, 'history');
                const q = query(historyRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);

                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-secondary">История операций пуста.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const logItem = document.createElement('div');
                    logItem.className = 'p-3 rounded-lg';
                    const isAdd = entry.type === 'add';
                    logItem.classList.add(isAdd ? 'history-item-add' : 'history-item-subtract');

                    const date = entry.timestamp.toDate().toLocaleString('ru-RU');
                    const changeText = isAdd ? `+${entry.change}` : `${entry.change}`;
                    const changeColor = isAdd ? 'text-green-700' : 'text-red-700';
                    const typeText = isAdd ? 'Приход' : 'Списание';
                    const commentHtml = entry.comment 
                        ? `<p class="text-sm text-secondary mt-1 italic">"${entry.comment}"</p>` 
                        : '';
                    
                    logItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold header-title">${typeText}</p>
                                <p class="text-sm text-secondary">${date}</p>
                                ${commentHtml}
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                               <p class="font-bold text-lg ${changeColor}">${changeText}</p>
                               <p class="text-sm text-secondary">Остаток: ${entry.newQuantity}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(logItem);
                });
            } catch (error) {
                handleFirebaseError(error, 'загрузке истории');
            }
        }
        function closeHistoryModal() { document.getElementById('history-modal').style.display = 'none'; }
    </script>
</body>
</html>

