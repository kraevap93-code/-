<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Материалы рулонной этикетки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --accent-color: #facc15; /* yellow-400 */
            --accent-text: #111827;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --approved-bg: rgba(74, 222, 128, 0.1);
            --unapproved-bg: rgba(248, 113, 113, 0.1);
        }

        html.dark {
            --bg-primary: #3f3f46;      /* zinc-700 */
            --bg-secondary: #27272a;    /* zinc-800 */
            --text-primary: #f4f4f5;    /* zinc-100 */
            --text-secondary: #a1a1aa;  /* zinc-400 */
            --accent-color: #facc15;    /* yellow-400 */
            --accent-text: #18181b;     /* zinc-900 */
            --border-color: #52525b;    /* zinc-600 */
            --card-bg: #3f3f46;         /* zinc-700 */
            --shadow-color: rgba(0, 0, 0, 0.4);
            --approved-bg: rgba(74, 222, 128, 0.15);
            --unapproved-bg: rgba(248, 113, 113, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .main-container { background-color: var(--bg-secondary); }
        .header-title { color: var(--text-primary); }
        .card { background-color: var(--card-bg); box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color); }
        .form-label { color: var(--text-secondary); }
        .form-input, .form-select { 
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .form-input:focus, .form-select:focus {
            --tw-ring-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        .btn-primary:hover { filter: brightness(0.9); }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .filter-btn.active-filter {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-color: var(--accent-color);
        }
        .filter-btn:not(.active-filter) {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
         .filter-btn:not(.active-filter):hover { background-color: var(--bg-secondary); }
        .sort-btn {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: background-color 0.2s;
        }
        .sort-btn:hover { background-color: var(--bg-secondary); }
        .category-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        .category-header { color: var(--text-primary); }
        .category-header-approved { background-color: var(--approved-bg); padding: 0.5rem; border-radius: 0.5rem; }
        .category-header-unapproved { background-color: var(--unapproved-bg); padding: 0.5rem; border-radius: 0.5rem; }
        .history-item-add { background-color: rgba(22, 163, 74, 0.1); }
        .history-item-subtract { background-color: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body class="main-container">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="card p-6 sm:p-8 rounded-2xl w-full max-w-md">
            <h2 id="auth-title" class="text-2xl sm:text-3xl font-bold text-center mb-6 header-title">Вход в систему</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium form-label mb-1">Email</label>
                    <input type="email" id="email" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium form-label mb-1">Пароль</label>
                    <input type="password" id="password" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div id="confirm-password-container" class="mb-6 hidden">
                     <label for="confirm-password" class="block text-sm font-medium form-label mb-1">Подтвердите пароль</label>
                     <input type="password" id="confirm-password" class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <button id="auth-button" type="submit" class="btn-primary w-full font-semibold py-2.5 px-4 rounded-lg transition duration-300">Войти</button>
            </form>
            <p id="auth-message" class="text-center mt-4 text-sm"></p>
            <p class="text-center mt-4 text-sm form-label">
                <span id="auth-toggle-prompt">Нет аккаунта?</span>
                <a href="#" id="toggle-auth-mode" class="font-semibold text-yellow-500 hover:underline">Зарегистрироваться</a>
            </p>
        </div>
    </div>

    <!-- Main App Screen (hidden by default) -->
    <div id="app-screen" class="hidden">
         <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
            <header class="mb-8">
                <!-- Top Bar: User Info & Theme Toggle -->
                <div class="flex justify-between items-center mb-4">
                    <!-- User Info -->
                    <div class="text-left">
                        <p class="text-sm text-secondary">Вы вошли как:</p>
                        <div class="flex items-center gap-2 flex-wrap">
                            <p id="user-email" class="font-semibold header-title break-all"></p>
                            <button id="global-history-btn" class="hidden text-sm bg-yellow-400 text-zinc-800 hover:bg-yellow-500 font-semibold px-3 py-1 rounded-md transition">Общая история</button>
                        </div>
                        <button id="logout-btn" class="text-sm text-red-500 hover:underline mt-1">Выйти</button>
                    </div>
                    <!-- Theme Toggle -->
                    <div>
                         <label for="theme-toggle-input" title="Переключить тему" class="relative w-16 h-8 flex items-center bg-sky-200 dark:bg-zinc-700 rounded-full cursor-pointer p-1 transition-colors duration-300">
                            <input type="checkbox" id="theme-toggle-input" class="sr-only peer">
                            <span class="w-6 h-6 bg-yellow-400 dark:bg-slate-300 rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center peer-checked:translate-x-8">
                                <svg class="h-4 w-4 text-white block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m16.96-7.96l-.707-.707M4.04 4.04l-.707-.707M12 12a2 2 0 100-4 2 2 0 000 4z" /></svg>
                                <svg class="h-4 w-4 text-zinc-800 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                            </span>
                        </label>
                    </div>
                </div>
                <!-- Main Title -->
                <div class="text-center">
                    <h1 class="text-3xl sm:text-4xl font-bold header-title">Материалы рулонной этикетки</h1>
                </div>
            </header>

            <div id="add-material-card" class="card p-6 rounded-2xl mb-8">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 header-title">Добавить материал</h2>
                <form id="add-material-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="material-category" class="block text-sm font-medium form-label mb-1">Категория</label>
                        <select id="material-category" required class="form-select w-full px-4 py-2 border rounded-lg transition">
                            <option value="Жидкие расходники">Жидкие расходники</option>
                            <option value="Краска">Краска</option>
                            <option value="Утвержденная самоклейка">Утвержденная самоклейка</option>
                            <option value="Самоклейка тест">Самоклейка тест</option>
                            <option value="Не утвержденная самоклейка">Не утвержденная самоклейка</option>
                            <option value="Фольга ДжетТач">Фольга ДжетТач</option>
                            <option value="Фольга DMS">Фольга DMS</option>
                            <option value="Другое">Другое</option>
                        </select>
                    </div>
                    <div>
                        <label for="material-name" class="block text-sm font-medium form-label mb-1">Название</label>
                        <input type="text" id="material-name" list="material-names-list" placeholder="Выберите или введите" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                        <datalist id="material-names-list"></datalist>
                    </div>
                    <div>
                        <label for="material-nomenclature" class="block text-sm font-medium form-label mb-1">Номенклатура поставщика</label>
                        <input type="text" id="material-nomenclature" placeholder="Введите номенклатуру" class="form-input w-full px-4 py-2 border rounded-lg transition">
                    </div>
                    <div id="material-width-container" class="hidden">
                        <label for="material-width" class="block text-sm font-medium form-label mb-1">Ширина (мм)</label>
                        <input type="number" id="material-width" placeholder="330" class="form-input w-full px-4 py-2 border rounded-lg transition">
                    </div>
                    <div>
                        <label for="material-quantity" class="block text-sm font-medium form-label mb-1">Количество</label>
                        <input type="number" id="material-quantity" placeholder="1000" step="any" required class="form-input w-full px-4 py-2 border rounded-lg transition">
                    </div>
                    <div>
                        <label for="material-unit" class="block text-sm font-medium form-label mb-1">Ед. изм.</label>
                        <select id="material-unit" required class="form-select w-full px-4 py-2 border rounded-lg transition">
                            <option value="кг">кг</option>
                            <option value="л">л</option>
                            <option value="м/п">м/п</option>
                            <option value="шт.">шт.</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary sm:col-span-2 lg:col-span-3 w-full font-semibold py-2.5 px-4 rounded-lg transition duration-300 mt-2">
                        Добавить
                    </button>
                </form>
            </div>
            <div>
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 header-title">Складские остатки</h2>
                <div class="mb-4">
                    <label for="name-search-input" class="block text-sm font-medium form-label mb-1">Поиск по названию или номенклатуре</label>
                    <input type="text" id="name-search-input" placeholder="Введите название или номенклатуру..." class="form-input w-full px-4 py-2 border rounded-lg transition">
                </div>
                <div id="category-filters" class="flex flex-wrap gap-2 mb-6">
                     <button data-category="All" class="filter-btn active-filter">Все</button>
                     <button data-category="Жидкие расходники" class="filter-btn">Жидкие расходники</button>
                     <button data-category="Краска" class="filter-btn">Краска</button>
                     <button data-category="Утвержденная самоклейка" class="filter-btn" style="background-color: var(--approved-bg);">Утвержденная самоклейка</button>
                     <button data-category="Самоклейка тест" class="filter-btn">Самоклейка тест</button>
                     <button data-category="Не утвержденная самоклейка" class="filter-btn" style="background-color: var(--unapproved-bg);">Не утвержденная самоклейка</button>
                     <button data-category="Фольга ДжетТач" class="filter-btn">Фольга ДжетТач</button>
                     <button data-category="Фольга DMS" class="filter-btn">Фольга DMS</button>
                     <button data-category="Другое" class="filter-btn">Другое</button>
                </div>
                <div id="width-search-container" class="mb-6 hidden">
                    <label for="width-search-input" class="block text-sm font-medium form-label mb-1">Поиск по ширине (мм)</label>
                    <div class="flex gap-2">
                        <input type="number" id="width-search-input" placeholder="Например, 330" class="form-input flex-grow md:flex-grow-0 md:w-1/3 px-4 py-2 border rounded-lg transition">
                        <button id="width-search-reset" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-zinc-600 dark:text-zinc-200 dark:hover:bg-zinc-500 rounded-lg hover:bg-gray-300 transition">Сброс</button>
                    </div>
                </div>
                <div id="error-container" class="hidden my-4 p-4 border border-red-500 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg">
                    <p id="error-message" class="text-center"></p>
                </div>
                <p id="loading-message" class="text-center text-secondary py-4">Загрузка данных...</p>
                <div id="materials-list" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="update-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-sm m-4 relative"><h3 class="text-xl font-semibold mb-4 header-title" id="modal-title">Обновить количество</h3><form id="update-quantity-form"><input type="hidden" id="modal-material-id"><input type="hidden" id="modal-action-type"><div><label for="quantity-change" class="block text-sm font-medium form-label mb-1">Значение</label><input type="number" id="quantity-change" min="0" step="any" placeholder="Введите число" required class="form-input w-full px-4 py-2 border rounded-lg transition"></div><div class="mt-4"><label for="quantity-comment" class="block text-sm font-medium form-label mb-1">Комментарий (необязательно)</label><textarea id="quantity-comment" placeholder="Например, номер заказа или причина" rows="3" class="form-input w-full px-4 py-2 border rounded-lg transition"></textarea></div><div class="mt-6 flex flex-wrap justify-end gap-2"><button type="button" id="cancel-update" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Отмена</button><button type="button" id="write-off-all-btn" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition hidden">Списать все</button><button type="submit" class="btn-primary px-4 py-2 rounded-lg transition">Подтвердить</button></div></form></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-sm m-4 relative"><h3 class="text-xl font-semibold mb-2 header-title">Подтверждение</h3><p class="text-secondary mb-6">Вы уверены, что хотите удалить этот материал?</p><div class="flex justify-end space-x-3"><button type="button" id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Отмена</button><button type="button" id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Удалить</button></div></div></div>
    <div id="history-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-lg m-4 relative flex flex-col" style="max-height: 90vh;"><div class="flex justify-between items-center mb-4 pb-4 border-b border-border-color"><h3 class="text-lg sm:text-xl font-semibold header-title" id="history-modal-title">История операций</h3><button id="close-history-modal" class="text-2xl text-secondary hover:text-primary">&times;</button></div><div id="history-log-container" class="overflow-y-auto space-y-2"></div></div></div>
    <div id="global-history-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4"><div class="modal-backdrop fixed inset-0"></div><div class="card p-6 rounded-2xl w-full max-w-3xl m-4 relative flex flex-col" style="max-height: 90vh;"><div class="flex justify-between items-center mb-4 pb-4 border-b border-border-color"><h3 class="text-lg sm:text-xl font-semibold header-title">Общая история всех операций</h3><button id="close-global-history-modal" class="text-2xl text-secondary hover:text-primary">&times;</button></div><div id="global-history-log-container" class="overflow-y-auto space-y-2"></div></div></div>

    <script type="module">
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyAaIh33CJZXGzN9JmzgCLOER8AfJJKIV80",
          authDomain: "cveta-67f31.firebaseapp.com",
          projectId: "cveta-67f31",
          storageBucket: "cveta-67f31.appspot.com",
          messagingSenderId: "379571445431",
          appId: "1:379571445431:web:d41e2477feac5c29e97732",
          measurementId: "G-7EYBRBV2JN"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs, runTransaction, query, orderBy, where, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global State & Constants ---
        let db, auth, currentUser;
        let materialsCollectionRef;
        let unsubscribe;
        let allMaterials = [];
        let currentFilter = 'All';
        let sortConfig = { category: 'Утвержденная самоклейка', direction: 'asc' };
        let isLoginMode = true;
        const ADMIN_EMAIL = "lequangduc19865@gmail.com";

        const nomenclatureMap = { 'Бумажная полуглянцевая': 'semi gloss paper am/aw01/yellow glassine(fz)', 'Белая полимерная': '60# pp pearl film(tc)/acrylic w05/white glassine', 'Прозрачный хрусталь': '50# transparent pp film(tc)/acrylic 32/30# pet liner', 'Императорский синий': 'BeautyStick(1-15)Blue', 'Императорский красный': 'BeautyStick(01-15)Silver', 'Императорское золото': 'BeautyStick(1-15)Gold', 'Императорское серебро': 'BeautyStick(1-15)Red', 'Глянцевое серебро': 'Bright Silver PP 50um/AS500/white glassine', 'Голографическое серебро': '50PP TRANSPARENT AS500WG60 125г/м2+MPET12 мкм WP-02 Радуга', 'Прозрачный сахар': 'Glitter Transparent LamiFilm(05-90)GT-LT85-30P', };
        const materialNameSuggestions = { 'Утвержденная самоклейка': ['Бумажная полуглянцевая', 'Белая полимерная', 'Прозрачный хрусталь', 'Императорский синий', 'Императорский красный', 'Императорское золото', 'Императорское серебро', 'Глянцевое серебро', 'Голографическое серебро', 'Прозрачный сахар'], 'Самоклейка тест': ['Бумажная - белая термобумага', 'Бумажная - полуглянцевая', 'Бумажная - белая винная', 'Бумажная - белая матовая', 'Бумажная - белая термобумага морозостойкая', 'Бумажная - белая полуглянцевая бумага', 'Бумажная - серебряная глянцевая бумага', 'Бумажная - серебряная матовая бумага', 'Бумажная - китайская полуглянцевая бумага', 'Полимерная - белая', 'Полимерная - мутная прозрачка', 'Полимерная - супер прозрачная', 'Полимерная - прозрачная', 'Полимерная - серебряная глянцевая', 'Полимерная - белая мутная', 'Полимерная - тонкая прозрачная', 'Другие - прозрачный ПВХ'], 'Не утвержденная самоклейка': ['Голографическая радуга', 'Черная самоклейка с тач покрытием', 'Мутная прозрачка (Pe85)', 'Винная бумага (Antarctic white от Стиктрейд)'], 'Фольга ДжетТач': [], 'Фольга DMS': ['Фольга золото ППФ', 'Фольга серебро ППФ', 'Фольга голография ППФ', 'Фольга зеленая ППФ', 'Фольга голография ДубльВ', 'Фольга золото ДубльВ', 'Фольга серебро ДубльВ'], 'Краска': ['GIP White', 'GIP Cyan', 'GIP Magenta', 'GIP Yellow', 'GIP Key'], 'Жидкие расходники': ['Антифриз Felix G12', 'Вода дистиллированная Oilright', 'Антифриз Prestone (для GIP)', 'Wash (для GIP)', 'Лак DMS SJ-SM01', 'Этилацетат (для мойки)', 'Метоксипропанол (УФ смывка)', 'Изопропиловый спирт (для мойки)', 'Platenclene (Очиститель валов)', 'Матовый лак VMG UV Flexo', 'Матовый лак Танзор Графилак UV 903', 'Праймер Танзор Графилак UV 368', 'Праймер Артмарк BUF-6301D-4', 'Wash DMS SJ-QX01', 'Водный раствор аммиака ЧДА'] };
        const initialDataRaw = [ { name: "Антифриз Felix G12", quantity: 20, unit: "кг", category: "Жидкие расходники" },{ name: "Вода дистиллированная Oilright", quantity: 10, unit: "л", category: "Жидкие расходники" },{ name: "Антифриз Prestone (для GIP)", quantity: 7.56, unit: "л", category: "Жидкие расходники" },{ name: "Wash (для GIP)", quantity: 52, unit: "л", category: "Жидкие расходники" }, { name: "GIP White", quantity: 96.8, unit: "л", category: "Краска" }, { name: "GIP Cyan", quantity: 63.5, unit: "л", category: "Краска" }, { name: "GIP Magenta", quantity: 62.5, unit: "л", category: "Краска" }, { name: "GIP Yellow", quantity: 64.3, unit: "л", category: "Краска" }, { name: "GIP Key", quantity: 63.2, unit: "л", category: "Краска" }, { name: "Лак DMS SJ-SM01", quantity: 70.5, unit: "л", category: "Жидкие расходники" },{ name: "Этилацетат (для мойки)", quantity: 35, unit: "л", category: "Жидкие расходники" },{ name: "Метоксипропанол (УФ смывка)", quantity: 16, unit: "кг", category: "Жидкие расходники" },{ name: "Изопропиловый спирт (для мойки)", quantity: 20, unit: "л", category: "Жидкие расходники" },{ name: "Platenclene (Очиститель валов)", quantity: 0.7, unit: "л", category: "Жидкие расходники" },{ name: "Матовый лак VMG UV Flexo", quantity: 37, unit: "кг", category: "Жидкие расходники" },{ name: "Матовый лак Танзор Графилак UV 903", quantity: 9, unit: "кг", category: "Жидкие расходники" },{ name: "Праймер Танзор Графилак UV 368", quantity: 4.5, unit: "кг", category: "Жидкие расходники" },{ name: "Праймер Артмарк BUF-6301D-4", quantity: 17.5, unit: "кг", category: "Жидкие расходники" },{ name: "Wash DMS SJ-QX01", quantity: 1, unit: "л", category: "Жидкие расходники" },{ name: "Водный раствор аммиака ЧДА", quantity: 9, unit: "кг", category: "Жидкие расходники" },{ name: "Бумажная полуглянцевая 330 мм", quantity: 43956, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Белая полимерная 330 мм", quantity: 7992, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный хрусталь 330 мм", quantity: 15000, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный хрусталь 280 мм", quantity: 9280, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорский синий 330 мм", quantity: 11050, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорский красный 330 мм", quantity: 11380, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское золото 330 мм", quantity: 7250, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское золото 270 мм", quantity: 4000, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Императорское серебро 330 мм", quantity: 10950, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Глянцевое серебро 210 мм", quantity: 17700, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Глянцевое серебро 330 мм", quantity: 76500, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 330 мм", quantity: 5578, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 214 мм", quantity: 6140, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Голографическое серебро 150 мм", quantity: 6140, unit: "м/п", category: "Утвержденная самоклейка" },{ name: "Прозрачный сахар 330 мм", quantity: 5450, unit: "м/п", category: "Утвержденная самоклейка" }, { name: "Фольга золото ППФ 330 мм", quantity: 4900, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ППФ 330 мм", quantity: 4900, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга голография ППФ 330 мм", quantity: 440, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга зеленая ППФ 330 мм", quantity: 450, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга голография ДубльВ 330 мм", quantity: 1500, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 330 мм", quantity: 500, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 330 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 100 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 130 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 150 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 160 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга золото ДубльВ 210 мм", quantity: 2000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 130 мм", quantity: 6000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 150 мм", quantity: 5000, unit: "м/п", category: "Фольга DMS" },{ name: "Фольга серебро ДубльВ 160 мм", quantity: 11000, unit: "м/п", category: "Фольга DMS" }, { name: "Бумажная - белая термобумага 210 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 250 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 290 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 280 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая винная 300 мм", quantity: 30, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - полуглянцевая 225 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 255 мм", quantity: 370, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая матовая 210 мм", quantity: 138, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага 251 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая термобумага морозостойкая 270 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая матовая 250 мм", quantity: 48, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая полуглянцевая бумага 320 мм", quantity: 490, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая полуглянцевая бумага 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - белая винная 140 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - серебряная глянцевая бумага 320 мм", quantity: 400, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - серебряная матовая бумага 320 мм", quantity: 390, unit: "м/п", category: "Самоклейка тест" }, { name: "Бумажная - китайская полуглянцевая бумага 330 мм", quantity: 500, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 305 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 320 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - супер прозрачная 290 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - супер прозрачная 250 мм", quantity: 60, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 330 мм", quantity: 230, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 170 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 330 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 300 мм", quantity: 50, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 280 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 230 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачка 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 300 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 265 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - серебряная глянцевая 330 мм", quantity: 40, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 330 мм", quantity: 350, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 295 мм", quantity: 200, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - прозрачная 250 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - мутная прозрачная 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая 330 мм", quantity: 400, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - белая мутная 330 мм", quantity: 300, unit: "м/п", category: "Самоклейка тест" }, { name: "Полимерная - тонкая прозрачная 330 мм", quantity: 800, unit: "м/п", category: "Самоклейка тест" }, { name: "Другие - прозрачный ПВХ 240 мм", quantity: 100, unit: "м/п", category: "Самоклейка тест" }, { name: "Голографическая радуга 330 мм", quantity: 11910, unit: "м/п", category: "Не утвержденная самоклейка", nomenclature: "50PP TRANSPARENT AS500WG60 125г/м2+UV TOP(01-18) IRIS T розово-зеленая" }, { name: "Черная самоклейка с тач покрытием 330 мм", quantity: 272, unit: "м/п", category: "Не утвержденная самоклейка" }, { name: "Мутная прозрачка (Pe85) 330 мм", quantity: 11589, unit: "м/п", category: "Не утвержденная самоклейка", nomenclature: "transparent pe film 85#/w05/white glassine" }, { name: "Винная бумага (Antarctic white от Стиктрейд) 330 мм", quantity: 100, unit: "м/п", category: "Не утвержденная самоклейка" }, ];
        
        // --- Main App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                document.body.innerHTML = '<h1>Ошибка инициализации Firebase. Проверьте объект firebaseConfig.</h1>';
                return;
            }

            onAuthStateChanged(auth, user => {
                const authScreen = document.getElementById('auth-screen');
                const appScreen = document.getElementById('app-screen');
                if (user) {
                    currentUser = user;
                    const isAdmin = currentUser.email === ADMIN_EMAIL;
                    
                    authScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                    
                    document.getElementById('user-email').innerHTML = `${user.email} ${isAdmin ? '<span class="text-xs font-bold text-yellow-500 bg-yellow-400/10 px-2 py-1 rounded-full">Администратор</span>' : ''}`;
                    document.getElementById('add-material-card').style.display = isAdmin ? 'block' : 'none';
                    document.getElementById('global-history-btn').style.display = isAdmin ? 'inline-block' : 'none';
                    
                    materialsCollectionRef = collection(db, `materials`);
                    checkAndAddInitialData();
                    listenForMaterials();
                } else {
                    currentUser = null;
                    authScreen.style.display = 'flex';
                    appScreen.style.display = 'none';
                    if (unsubscribe) unsubscribe();
                }
            });
            
            setupEventListeners();
            updateAuthView();
        });

        // --- Helper Functions ---
        function processInitialData(data) {
            return data.map(item => {
                const match = item.name.match(/(\s*\d+\s*мм)/);
                let newItem = { ...item, width: null, nomenclature: item.nomenclature || null };
                if (match) {
                    newItem.width = parseInt(match[1].trim(), 10);
                    newItem.name = item.name.replace(match[0], '').trim();
                }
                if (newItem.category === 'Утвержденная самоклейка' && nomenclatureMap[newItem.name]) {
                    newItem.nomenclature = nomenclatureMap[newItem.name];
                }
                return newItem;
            });
        }
        const initialData = processInitialData(initialDataRaw);

        function handleFirebaseError(error, context) {
            console.error(`Firebase Error in ${context}:`, error);
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const loadingMessage = document.getElementById('loading-message');
            if(loadingMessage) loadingMessage.style.display = 'none';
            if (error.code === 'auth/configuration-not-found') {
                errorMessage.innerHTML = '<strong>Ошибка конфигурации:</strong> Email/Password вход не включен в вашем проекте Firebase. <br>Пожалуйста, перейдите в Firebase Console -> Authentication -> Sign-in method и включите провайдера "Email/Password".';
            } else if (error.code === 'permission-denied') {
                errorMessage.innerHTML = `<strong>Ошибка доступа:</strong> У вас нет прав для выполнения этого действия. Убедитесь, что ваши правила Firestore настроены правильно.`;
            } else {
                errorMessage.textContent = `Произошла ошибка при "${context}". Проверьте консоль.`;
            }
            errorContainer.classList.remove('hidden');
        }

        function updateAuthView() {
            const authTitle = document.getElementById('auth-title');
            const authButton = document.getElementById('auth-button');
            const confirmPasswordContainer = document.getElementById('confirm-password-container');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const authTogglePrompt = document.getElementById('auth-toggle-prompt');
            const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
            const authMessage = document.getElementById('auth-message');

            authMessage.textContent = ''; 

            if (isLoginMode) {
                authTitle.textContent = 'Вход в систему';
                authButton.textContent = 'Войти';
                confirmPasswordContainer.classList.add('hidden');
                confirmPasswordInput.required = false;
                authTogglePrompt.textContent = 'Нет аккаунта? ';
                toggleAuthModeLink.textContent = 'Зарегистрироваться';
            } else {
                authTitle.textContent = 'Регистрация';
                authButton.textContent = 'Зарегистрироваться';
                confirmPasswordContainer.classList.remove('hidden');
                confirmPasswordInput.required = true;
                authTogglePrompt.textContent = 'Уже есть аккаунт? ';
                toggleAuthModeLink.textContent = 'Войти';
            }
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Auth Listeners
            document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                updateAuthView();
            });

            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const authMessage = document.getElementById('auth-message');
                authMessage.textContent = '';
                authMessage.classList.remove('text-green-500', 'text-red-500');
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                if (isLoginMode) {
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        console.error("Login Error:", error);
                        authMessage.classList.add('text-red-500');
                        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                            authMessage.textContent = 'Неверный email или пароль.';
                        } else {
                            authMessage.textContent = 'Произошла ошибка входа.';
                        }
                    }
                } else { // Registration Mode
                    const confirmPassword = document.getElementById('confirm-password').value;
                    if (password !== confirmPassword) {
                        authMessage.textContent = 'Пароли не совпадают.';
                        authMessage.classList.add('text-red-500');
                        return;
                    }
                    if (password.length < 6) {
                        authMessage.textContent = 'Пароль должен быть не менее 6 символов.';
                        authMessage.classList.add('text-red-500');
                        return;
                    }
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        authMessage.textContent = 'Регистрация прошла успешно! Теперь вы можете войти.';
                        authMessage.classList.add('text-green-500');
                        isLoginMode = true;
                        updateAuthView();
                    } catch (error) {
                        console.error("Registration Error:", error);
                        authMessage.classList.add('text-red-500');
                        if (error.code === 'auth/email-already-in-use') {
                            authMessage.textContent = 'Этот email уже зарегистрирован.';
                        } else if (error.code === 'auth/weak-password') {
                            authMessage.textContent = 'Пароль слишком слабый.';
                        } else {
                            authMessage.textContent = 'Произошла ошибка регистрации.';
                        }
                    }
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth);
            });
            
            document.getElementById('global-history-btn').addEventListener('click', openGlobalHistoryModal);

            // Add Material Form
            const addForm = document.getElementById('add-material-form');
            addForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('material-name').value.trim();
                const quantity = document.getElementById('material-quantity').value;
                const unit = document.getElementById('material-unit').value;
                const category = document.getElementById('material-category').value;
                const width = document.getElementById('material-width').value;
                const nomenclature = document.getElementById('material-nomenclature').value.trim();
                if (name && quantity && unit && category) {
                    addMaterial(name, quantity, unit, category, width || null, nomenclature || null);
                    document.getElementById('material-name').value = '';
                    document.getElementById('material-quantity').value = '';
                    document.getElementById('material-width').value = '';
                    document.getElementById('material-nomenclature').value = '';
                    handleCategoryChange();
                }
            });
            document.getElementById('material-category').addEventListener('change', handleCategoryChange);

            // Material List Actions
            document.getElementById('materials-list').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('sort-btn')) {
                    sortConfig.category = target.dataset.category;
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    renderMaterials();
                    return;
                }
                const materialId = target.dataset.id;
                if (target.classList.contains('update-btn')) openUpdateModal(materialId, target.dataset.action);
                if (target.classList.contains('delete-btn')) openDeleteConfirmModal(materialId);
                if (target.classList.contains('history-btn')) openHistoryModal(materialId, target.dataset.name);
            });

            // Filters
            document.getElementById('category-filters').addEventListener('click', (e) => {
                const target = e.target.closest('button.filter-btn');
                if (target) {
                    currentFilter = target.dataset.category;
                    document.querySelector('#category-filters .active-filter').classList.remove('active-filter');
                    target.classList.add('active-filter');
                    const showWidthSearch = ['Утвержденная самоклейка', 'Самоклейка тест', 'Не утвержденная самоклейка', 'Фольга ДжетТач', 'Фольга DMS', 'All'].includes(currentFilter);
                    document.getElementById('width-search-container').classList.toggle('hidden', !showWidthSearch);
                    document.getElementById('width-search-input').value = '';
                    renderMaterials();
                }
            });
            document.getElementById('name-search-input').addEventListener('input', renderMaterials);
            document.getElementById('width-search-input').addEventListener('input', renderMaterials);
            document.getElementById('width-search-reset').addEventListener('click', () => {
                document.getElementById('width-search-input').value = '';
                renderMaterials();
            });

            // Modal Listeners
            document.getElementById('update-quantity-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('modal-material-id').value;
                const action = document.getElementById('modal-action-type').value;
                const changeValue = Number(document.getElementById('quantity-change').value);
                const comment = document.getElementById('quantity-comment').value.trim();
                if (id && changeValue > 0) {
                    updateMaterialQuantity(id, action === 'add' ? changeValue : -changeValue, comment);
                    closeUpdateModal();
                }
            });
            document.getElementById('write-off-all-btn').addEventListener('click', () => {
                const id = document.getElementById('modal-material-id').value;
                const material = allMaterials.find(m => m.id === id);
                const comment = document.getElementById('quantity-comment').value.trim() || 'Списание всех остатков';
                if (material) {
                    updateMaterialQuantity(id, -material.quantity, comment);
                    closeUpdateModal();
                }
            });
            document.getElementById('cancel-update').addEventListener('click', closeUpdateModal);
            document.querySelector('#update-modal .modal-backdrop').addEventListener('click', closeUpdateModal);
            document.getElementById('confirm-delete').addEventListener('click', () => {
                const materialId = document.getElementById('confirm-delete').dataset.id;
                if(materialId) {
                    deleteMaterial(materialId);
                    closeDeleteConfirmModal();
                }
            });
            document.getElementById('cancel-delete').addEventListener('click', closeDeleteConfirmModal);
            document.querySelector('#delete-confirm-modal .modal-backdrop').addEventListener('click', closeDeleteConfirmModal);
            document.getElementById('close-history-modal').addEventListener('click', closeHistoryModal);
            document.querySelector('#history-modal .modal-backdrop').addEventListener('click', closeHistoryModal);
            document.getElementById('close-global-history-modal').addEventListener('click', closeGlobalHistoryModal);
            document.querySelector('#global-history-modal .modal-backdrop').addEventListener('click', closeGlobalHistoryModal);

        
            // Theme toggle listener
            const themeToggleInput = document.getElementById('theme-toggle-input');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggleInput.checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggleInput.checked = false;
                }
            }

            themeToggleInput.addEventListener('change', () => {
                const newTheme = themeToggleInput.checked ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        }

        // --- Firebase Data Functions ---
        async function checkAndAddInitialData() {
             try {
                const snapshot = await getDocs(materialsCollectionRef);
                if (snapshot.empty) {
                    const batch = writeBatch(db);
                    initialData.forEach(material => {
                        const docRef = doc(materialsCollectionRef);
                        batch.set(docRef, { ...material, createdAt: new Date() });
                    });
                    await batch.commit();
                }
            } catch (error) {
                handleFirebaseError(error, 'проверке и добавлении начальных данных');
            }
        }
        function listenForMaterials() {
            if (unsubscribe) unsubscribe();
            const q = query(materialsCollectionRef);
            unsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('error-container').classList.add('hidden');
                allMaterials = [];
                snapshot.forEach((doc) => {
                    allMaterials.push({ id: doc.id, ...doc.data() });
                });
                renderMaterials();
            }, (error) => {
                handleFirebaseError(error, 'получении данных в реальном времени');
            });
        }
        async function addMaterial(name, quantity, unit, category, width, nomenclature) {
            try {
                const materialWidth = width ? Number(width) : null;
                const q = query( materialsCollectionRef, where("name", "==", name), where("category", "==", category), where("width", "==", materialWidth) );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const existingDoc = querySnapshot.docs[0];
                    await updateMaterialQuantity(existingDoc.id, Number(quantity), 'Приход');
                } else {
                    const newMaterialRef = doc(materialsCollectionRef);
                    const historyRef = collection(newMaterialRef, 'history');
                    const batch = writeBatch(db);
                    const materialData = { name, quantity: Number(quantity), unit, category, createdAt: new Date(), width: materialWidth, nomenclature: nomenclature || null };
                    batch.set(newMaterialRef, materialData);
                    batch.set(doc(historyRef), { 
                        change: Number(quantity), 
                        newQuantity: Number(quantity), 
                        type: 'add', 
                        timestamp: new Date(), 
                        user: currentUser.email, 
                        comment: 'Первоначальное добавление',
                        materialName: name,
                        materialWidth: materialWidth
                    });
                    await batch.commit();
                }
            } catch (error) {
                 handleFirebaseError(error, 'добавлении материала');
            }
        }
        async function updateMaterialQuantity(id, quantityChange, comment = '') {
            const materialRef = doc(materialsCollectionRef, id);
            const historyRef = collection(materialRef, 'history');
            try {
                await runTransaction(db, async (transaction) => {
                    const materialDoc = await transaction.get(materialRef);
                    if (!materialDoc.exists()) { throw "Документ не существует!"; }
                    
                    const materialData = materialDoc.data();
                    const currentQuantity = materialData.quantity;
                    const newQuantity = currentQuantity + quantityChange;
                    if (newQuantity < 0) { return; }
                    
                    transaction.update(materialRef, { quantity: newQuantity });
                    
                    const historyDocRef = doc(historyRef);
                    transaction.set(historyDocRef, {
                        change: quantityChange,
                        newQuantity: newQuantity,
                        type: quantityChange > 0 ? 'add' : 'subtract',
                        timestamp: new Date(),
                        user: currentUser ? currentUser.email : 'Unknown',
                        comment: comment,
                        materialName: materialData.name,
                        materialWidth: materialData.width || null
                    });
                });
            } catch (error) {
                handleFirebaseError(error, 'обновлении количества');
            }
        }
        async function deleteMaterial(id) {
            try {
                await deleteDoc(doc(materialsCollectionRef, id));
            } catch (error) {
                handleFirebaseError(error, 'удалении материала');
            }
        }

        // --- UI Rendering & Modal Functions ---
        function renderMaterials() {
            const listElement = document.getElementById('materials-list');
            const loadingMessage = document.getElementById('loading-message');
            const widthSearchInput = document.getElementById('width-search-input');
            const nameSearchInput = document.getElementById('name-search-input');
            let materialsToRender = currentFilter === 'All' ? allMaterials : allMaterials.filter(m => m.category === currentFilter);
            const nameSearchTerm = nameSearchInput.value.toLowerCase().trim();
            if (nameSearchTerm) {
                materialsToRender = materialsToRender.filter(m => m.name.toLowerCase().includes(nameSearchTerm) || (m.nomenclature && m.nomenclature.toLowerCase().includes(nameSearchTerm)) );
            }
            const searchWidth = widthSearchInput.value;
            if (searchWidth) {
                 materialsToRender = materialsToRender.filter(m => m.width === Number(searchWidth));
            }
            listElement.innerHTML = '';
            if (document.getElementById('error-container').classList.contains('hidden')) {
                loadingMessage.style.display = materialsToRender.length === 0 ? 'block' : 'none';
                loadingMessage.textContent = 'Материалы не найдены.';
            }
            const groupedByCategory = materialsToRender.reduce((acc, material) => {
                const category = material.category || 'Другое';
                if (!acc[category]) acc[category] = [];
                acc[category].push(material);
                return acc;
            }, {});
            Object.keys(groupedByCategory).sort().forEach(category => {
                const categoryHeaderContainer = document.createElement('div');
                categoryHeaderContainer.className = 'category-header-container';
                if (category === 'Утвержденная самоклейка') { categoryHeaderContainer.classList.add('category-header-approved'); }
                else if (category === 'Не утвержденная самоклейка') { categoryHeaderContainer.classList.add('category-header-unapproved'); }
                categoryHeaderContainer.innerHTML = `<h3 class="text-xl font-bold category-header">${category}</h3>`;
                if (['Утвержденная самоклейка', 'Самоклейка тест', 'Не утвержденная самоклейка'].includes(category)) {
                    const sortButton = document.createElement('button');
                    sortButton.className = 'sort-btn';
                    sortButton.dataset.category = category;
                    sortButton.innerHTML = `Ширина ${sortConfig.direction === 'asc' ? '▲' : '▼'}`;
                    categoryHeaderContainer.appendChild(sortButton);
                }
                const categoryContainer = document.createElement('div');
                categoryContainer.appendChild(categoryHeaderContainer);
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-3';
                const sortedItems = groupedByCategory[category].sort((a, b) => {
                    if (['Утвержденная самоклейка', 'Самоклейка тест', 'Не утвержденная самоклейка'].includes(category)) {
                        return sortConfig.direction === 'asc' ? (a.width || 0) - (b.width || 0) : (b.width || 0) - (a.width || 0);
                    }
                    return a.name.localeCompare(b.name);
                });
                sortedItems.forEach(material => {
                    const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4';
                    const quantityColor = material.quantity < 100 ? 'text-red-500' : 'text-green-600';
                    card.innerHTML = ` <div class="flex-grow"> <div class="flex items-baseline gap-3 flex-wrap"> <h4 class="text-lg font-bold header-title">${material.name}</h4> ${material.width ? `<p class="text-base font-semibold text-yellow-400 bg-yellow-400/10 px-2 py-0.5 rounded-full">${material.width} мм</p>` : ''} </div> ${material.nomenclature ? `<p class="text-xs text-secondary mt-1">${material.nomenclature}</p>` : ''} <p class="text-sm text-secondary mt-2">Остаток:</p> <p class="text-2xl font-bold ${quantityColor}">${material.quantity} <span class="text-base font-normal">${material.unit}</span></p> </div> <div class="flex items-center gap-2 w-full sm:w-auto"> <button data-id="${material.id}" data-action="add" class="update-btn flex-1 sm:flex-none w-10 h-10 text-green-700 hover:bg-green-100 dark:hover:bg-green-900/50 dark:text-green-400 rounded-full flex items-center justify-center text-2xl font-bold transition">+</button> <button data-id="${material.id}" data-action="subtract" class="update-btn flex-1 sm:flex-none w-10 h-10 text-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 dark:text-yellow-400 rounded-full flex items-center justify-center text-2xl font-bold transition">-</button> <button data-id="${material.id}" data-name="${material.name}" class="history-btn flex-1 sm:flex-none w-10 h-10 text-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900/50 dark:text-blue-400 rounded-full flex items-center justify-center transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button> ${isAdmin ? `<button data-id="${material.id}" class="delete-btn flex-1 sm:flex-none w-10 h-10 text-red-700 hover:bg-red-100 dark:hover:bg-red-900/50 dark:text-red-400 rounded-full flex items-center justify-center transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''} </div>`;
                    itemsContainer.appendChild(card);
                });
                categoryContainer.appendChild(itemsContainer);
                listElement.appendChild(categoryContainer);
            });
        }
        function handleCategoryChange() { const categorySelect = document.getElementById('material-category'); const widthContainer = document.getElementById('material-width-container'); const nameDatalist = document.getElementById('material-names-list'); const nameInput = document.getElementById('material-name'); const selectedCategory = categorySelect.value; const categoriesWithWidth = ['Утвержденная самоклейка', 'Самоклейка тест', 'Не утвержденная самоклейка', 'Фольга ДжетТач', 'Фольга DMS']; widthContainer.classList.toggle('hidden', !categoriesWithWidth.includes(selectedCategory)); nameDatalist.innerHTML = ''; nameInput.value = ''; if (materialNameSuggestions[selectedCategory]) { materialNameSuggestions[selectedCategory].forEach(name => { const option = document.createElement('option'); option.value = name; nameDatalist.appendChild(option); }); } }
        function openUpdateModal(id, action) { const modal = document.getElementById('update-modal'); const writeOffBtn = document.getElementById('write-off-all-btn'); document.getElementById('modal-material-id').value = id; document.getElementById('modal-action-type').value = action; document.getElementById('update-quantity-form').reset(); document.getElementById('modal-title').textContent = action === 'add' ? 'Приход материала' : 'Списание материала'; if (action === 'subtract') { writeOffBtn.classList.remove('hidden'); } else { writeOffBtn.classList.add('hidden'); } modal.style.display = 'flex'; }
        function closeUpdateModal() { document.getElementById('update-modal').style.display = 'none'; }
        function openDeleteConfirmModal(id) { const modal = document.getElementById('delete-confirm-modal'); document.getElementById('confirm-delete').dataset.id = id; modal.style.display = 'flex'; }
        function closeDeleteConfirmModal() { document.getElementById('delete-confirm-modal').style.display = 'none'; }
        async function openHistoryModal(id, name) {
            const modal = document.getElementById('history-modal');
            const title = document.getElementById('history-modal-title');
            const container = document.getElementById('history-log-container');
            title.textContent = `История: ${name}`;
            container.innerHTML = '<p class="text-secondary">Загрузка истории...</p>';
            modal.style.display = 'flex';
            try {
                const historyRef = collection(db, `materials/${id}/history`);
                const q = query(historyRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-secondary">История операций пуста.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const logItem = document.createElement('div');
                    logItem.className = 'p-3 rounded-lg';
                    const isAdd = entry.type === 'add';
                    logItem.classList.add(isAdd ? 'history-item-add' : 'history-item-subtract');
                    const date = entry.timestamp.toDate().toLocaleString('ru-RU');
                    const changeText = isAdd ? `+${entry.change}` : `${entry.change}`;
                    const changeColor = isAdd ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400';
                    const typeText = isAdd ? 'Приход' : 'Списание';
                    const commentHtml = entry.comment ? `<p class="text-sm text-secondary mt-1 italic">"${entry.comment}"</p>` : '';
                    const userHtml = entry.user ? `<p class="text-xs text-secondary mt-1">Пользователь: ${entry.user}</p>` : '';
                    logItem.innerHTML = ` <div class="flex justify-between items-start"> <div> <p class="font-semibold header-title">${typeText}</p> <p class="text-sm text-secondary">${date}</p> ${commentHtml} ${userHtml} </div> <div class="text-right flex-shrink-0 ml-4"> <p class="font-bold text-lg ${changeColor}">${changeText}</p> <p class="text-sm text-secondary">Остаток: ${entry.newQuantity}</p> </div> </div> `;
                    container.appendChild(logItem);
                });
            } catch (error) {
                handleFirebaseError(error, 'загрузке истории');
            }
        }
        function closeHistoryModal() { document.getElementById('history-modal').style.display = 'none'; }
        
        async function openGlobalHistoryModal() {
            const modal = document.getElementById('global-history-modal');
            const container = document.getElementById('global-history-log-container');
            container.innerHTML = '<p class="text-secondary">Загрузка общей истории...</p>';
            modal.style.display = 'flex';

            try {
                const historyQuery = query(collectionGroup(db, 'history'), orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(historyQuery);
                
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-secondary">История операций пуста.</p>';
                    return;
                }

                const materialNamesCache = new Map();

                for (const doc of snapshot.docs) {
                    const entry = doc.data();
                    let materialDisplayName = 'Неизвестный материал';

                    if (entry.materialName) {
                        materialDisplayName = `${entry.materialName} ${entry.materialWidth ? `(${entry.materialWidth} мм)` : ''}`;
                    } else {
                        const materialDocRef = doc.ref.parent.parent;
                        if (materialDocRef) {
                            if (materialNamesCache.has(materialDocRef.id)) {
                                materialDisplayName = materialNamesCache.get(materialDocRef.id);
                            } else {
                                try {
                                    const materialDocSnap = await getDoc(materialDocRef);
                                    if (materialDocSnap.exists()) {
                                        const materialData = materialDocSnap.data();
                                        materialDisplayName = `${materialData.name} ${materialData.width ? `(${materialData.width} мм)` : ''}`;
                                        materialNamesCache.set(materialDocRef.id, materialDisplayName);
                                    }
                                } catch (e) { console.error("Could not fetch parent material:", e); }
                            }
                        }
                    }
                    
                    const logItem = document.createElement('div');
                    logItem.className = 'p-3 rounded-lg';
                    const isAdd = entry.type === 'add';
                    logItem.classList.add(isAdd ? 'history-item-add' : 'history-item-subtract');

                    const date = entry.timestamp.toDate().toLocaleString('ru-RU');
                    const changeText = isAdd ? `+${entry.change}` : `${entry.change}`;
                    const changeColor = isAdd ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400';
                    const typeText = isAdd ? 'Приход' : 'Списание';
                    const commentHtml = entry.comment ? `<p class="text-sm text-secondary mt-1 italic">"${entry.comment}"</p>` : '';
                    const userDisplay = entry.user || 'Неизвестно';
                    const userHtml = `<p class="text-xs text-secondary mt-1">Пользователь: ${userDisplay}</p>`;

                    logItem.innerHTML = `
                        <div class="flex justify-between items-start flex-wrap">
                            <div>
                                <p class="font-bold header-title">${materialDisplayName}</p>
                                <p class="font-semibold header-title">${typeText}</p>
                                <p class="text-sm text-secondary">${date}</p>
                                ${commentHtml}
                                ${userHtml}
                            </div>
                            <div class="text-right flex-shrink-0 ml-4 mt-2 sm:mt-0">
                               <p class="font-bold text-lg ${changeColor}">${changeText}</p>
                               <p class="text-sm text-secondary">Остаток: ${entry.newQuantity}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(logItem);
                }
            } catch (error) {
                 handleFirebaseError(error, 'загрузке общей истории');
            }
        }
        function closeGlobalHistoryModal() { document.getElementById('global-history-modal').style.display = 'none'; }

    </script>
</body>
</html>

